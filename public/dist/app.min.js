"use strict";var app,gps=angular.module("gps",["ngRoute","satellizer","leaflet-directive"]);gps.config(["$locationProvider",function(e){e.html5Mode(!1)}]),gps.config(["$authProvider",function(e){e.loginUrl="/api/user/login"}]),gps.run(["$rootScope","$location","gpsService",function(e,n,o){e.location=n,e.user=o.user,e.api=o.api}]),$(window.document).ready(function(){$(".sidebar").sidebar({overlay:!0})}),(app=angular.module("gps")).controller("MapController",["$scope","$http","$timeout","$location","$routeParams","$q","leafletBoundsHelpers","leafletData","gpsService",function(l,t,n,i,e,o,r,a,s){l.api=s.api,l.user=s.user,t.get("json/center.json").success(function(e){l.center=e.center}),angular.extend(l,{center:{},nodes:{},paths:{},linksPromise:o.defer(),nodesPromise:o.defer(),bounds:[],events:{markers:{enable:["click"],logic:"emit"},paths:{enable:["mouseout","mouseover","mousedown"],logic:"emit"}},layers:{baselayers:{osm:{name:"OpenStreetMap",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",type:"xyz"},googleHybrid:{name:"Google Hybrid",layerType:"HYBRID",type:"google"}},overlays:{discovered:{name:"Discovered links",type:"group",visible:!1}}}});var c={0:"#491",1:"#FFFF00",2:"#FF8800",3:"#FF0000"},d=function(e){return{lat:l.nodes[e].lat,lng:l.nodes[e].lng}},u=function(e){n(function(){$(".sidebar").sidebar("show"),l.active=e},300)};l.closeSidebar=function(){$(".sidebar").sidebar("hide")},l.$on("$routeChangeSuccess",function(e,n){console.log("router"),angular.isDefined(n.params.node)?l.nodesPromise.promise.then(function(e){u(e[n.params.node])}):angular.isDefined(n.params.n1)&&l.linksPromise.promise.then(function(e){u(e[n.params.n1+"_"+n.params.n2])})}),l.$on("leafletDirectivePath.mouseout",function(e,n){if(0!==i.path().indexOf("/path")){var o=l.paths[n.modelName];l.active&&l.active.name===o.name||(o.color=o.activeColor)}}),l.$on("leafletDirectivePath.mouseover",function(e,n){0!==i.path().indexOf("/path")&&(l.paths[n.modelName].color="#FFF")}),l.$on("leafletDirectivePath.mousedown",function(e,n){var o=l.nodes[n.modelName.split("_")[0]],a=l.nodes[n.modelName.split("_")[1]];l.bounds=r.createBoundsFromArray([[o.lat,o.lng],[a.lat,a.lng]]),i.url("/link/"+n.modelName.replace("_","/"))}),l.$on("leafletDirectiveMarker.click",function(e,n){var o=l.nodes[n.modelName];l.center.lat=o.lat,l.center.lng=o.lng,i.url("/node/"+o.name)}),console.log("lala"),t.get("/api/node/").success(function(e){for(var n in e){var o=e[n],r="<strong>"+o.name+" ("+o.ip+")</strong>",a={icon:{type:"awesomeMarker",icon:"fa-star",color:o.alive?"blue":"red",prefix:"fa",shape:"circle",labelAnchor:[10,-24]},label:{message:r,direction:"auto"},riseOnHover:!0,lat:o.lat,lng:o.lng,name:o.name,node:o};l.nodes[o.name]=a}l.nodesPromise.resolve(l.nodes),t.get("/api/link/").success(function(e){angular.forEach(e,function(e){var n=e.nodes[0],o=e.nodes[1],a=d(n.name),t=d(o.name),i=e.bandwidth/5+2;10<i&&(i=10),r='<img style="width: 380px;"" src="/graph/bandwidth/'+n.name+"/"+o.name+'">',l.paths[n.name+"_"+o.name]={id:e._id,type:"polyline",weight:i,color:c[e.saturation],activeColor:c[e.saturation],saturation:e.saturation,label:{message:r},opacity:.9,name:n.name+"-"+o.name,network:e.network,distance:e.distance,nodes:[e.nodes[0].name,e.nodes[1].name],latlngs:[a,t],link:{n1:n,n2:o}}}),t.get("/api/link/autodiscovered").success(function(e){angular.forEach(e,function(e){var n=e.nodes[0],o=e.nodes[1],a=d(n.name),t=d(o.name);l.paths[n.name+"_"+o.name]={id:e._id,type:"polyline",layer:"discovered",discovered:e.discovered,weight:10,color:"#000",activeColor:"#000",opacity:.9,name:n.name+"-"+o.name,network:e.network,distance:e.distance,nodes:[e.nodes[0].name,e.nodes[1].name],latlngs:[a,t],link:{n1:n,n2:o}}}),l.linksPromise.resolve(l.paths)})})})}]),(app=angular.module("gps")).controller("NodeController",["$scope","$routeParams","$http","$window",function(r,o,a,t){angular.extend(r,{center:{lat:0,lng:0,zoom:1},layers:{baselayers:{googleHybrid:{name:"Google Hybrid",layerType:"HYBRID",type:"google"},osm:{name:"OpenStreetMap",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",type:"xyz"}}},markers:{}}),r.$on("leafletDirectiveMarker.click",function(e,n){t.location.href="/#/node/"+o.node}),r.$on("$routeChangeSuccess",function(e,n){var i=n.params.node;a.get("/api/node/"+i).success(function(e){r.center={lat:e.lat,lng:e.lng,zoom:16},r.markers={main:{lat:e.lat,lng:e.lng,icon:{type:"awesomeMarker",icon:"fa-star",color:e.alive?"blue":"red",prefix:"fa",shape:"circle",labelAnchor:[10,-24]},label:{message:"<strong>"+e.name+"</strong>",direction:"auto",options:{noHide:!0}}}},r.node=e}),a.get("/api/node/"+i+"/links").success(function(e){var n={};for(var o in e){var a=e[o],t={};a.nodes[0].name!==i?t.name=a.nodes[0].name:t.name=a.nodes[1].name,t.distance=a.distance,n[t.name]=t}r.neighbors=n})})}]),(app=angular.module("gps")).controller("LinkController",["$scope","$http","leafletBoundsHelpers","leafletData","$window","$rootScope",function(t,i,e,r,o,l){$(".ui.dropdown").dropdown(),angular.extend(t,{center:{},layers:{baselayers:{googleHybrid:{name:"Google Hybrid",layerType:"HYBRID",type:"google"},osm:{name:"OpenStreetMap",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",type:"xyz"}}},markers:{},bounds:{},paths:{}}),t.$on("leafletDirectivePath.click",function(e,n){o.location.href="/#/link/"+n.pathName.replace("_","/")}),t.$on("leafletDirectiveMarker.click",function(e,n){o.location.href="/#/node/"+n.name}),l.$on("linkUpdated",function(e){var n=t.nodes[t.link.nodes[0].name],o=t.nodes[t.link.nodes[1].name];t.paths[n.name+"_"+o.name].color=l.api.getColor(t.link),console.log(e)}),t.$on("$routeChangeSuccess",function(e,n){if(n&&n.params){var o=n.params.n1,a=n.params.n2;i.get("/api/link/"+o+"/"+a).success(function(e){t.link=e.link,t.nodes=e.nodes,o=t.nodes[e.link.nodes[0].name],a=t.nodes[e.link.nodes[1].name];var n=e.link.bandwidth/5+2;10<n&&(n=10),t.paths[o.name+"_"+a.name]={weight:n,saturation:e.link.saturation,color:l.api.getColor(t.link),label:{message:"<p>"+e.link.distance+" meters</p>"},opacity:.9,latlngs:[{lat:o.lat,lng:o.lng},{lat:a.lat,lng:a.lng}]},t.markers={n1:{lat:o.lat,lng:o.lng,icon:{type:"awesomeMarker",icon:"fa-star",color:o.alive?"blue":"red",prefix:"fa",shape:"circle",labelAnchor:[10,-24]},label:{message:"<strong>"+o.name+"</strong>",direction:"auto",options:{noHide:!0}}},n2:{lat:a.lat,lng:a.lng,icon:{type:"awesomeMarker",icon:"fa-star",color:a.alive?"blue":"red",prefix:"fa",shape:"circle",labelAnchor:[10,-24]},label:{message:"<strong>"+a.name+"</strong>",direction:"auto",options:{noHide:!0}}}},r.getMap().then(function(e){e.fitBounds([[o.lat,o.lng],[a.lat,a.lng]])})})}})}]);var gpsService=function(o,a,t){var n={0:"#491",1:"#FFFF00",2:"#FF8800",3:"#FF0000"};return{api:{getColor:function(e){return e.discovered?"#000":n[e.saturation]},deleteLink:function(e){var n=e.id||e._id;!0===confirm("Are you sure?")&&o.delete("/api/link/"+n).success(function(e){})},disableLink:function(n){var e=n.id||n._id;o.put("/api/link/"+e+"/disable/").success(function(e){n.discovered=!0,t.$emit("linkUpdated",{discovered:!0})})},addNode:function(){},enableLink:function(n){var e=n.id||n._id;o.put("/api/link/"+e+"/enable/").success(function(e){n.discovered=!1,t.$emit("linkUpdated",{discovered:!1})})}},user:{authenticate:function(e,n){return a.authenticate(e)},login:function(e,n,o){return a.login({email:e,password:n},o)},getUser:function(){return o.get("/api/user")},isAuthenticated:function(){return a.isAuthenticated()},toggleLink:function(n,o){o[n]?a.unlink(n).then(function(){o[n]=void 0}):a.link(n).then(function(e){o[n]=e})},logout:function(e){a.logout(e)}}}};gpsService.$inject=["$http","$auth","$rootScope"],angular.module("gps").factory("gpsService",gpsService);